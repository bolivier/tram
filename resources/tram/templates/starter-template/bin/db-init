#!/usr/bin/env bash
set -euo pipefail

# Config
CONTAINER_NAME="tram-postgres-sample-app"
DB_USER="tram"
DB_NAME1="sample_app_development"
DB_NAME2="sample_app_test"
HOST_USER="${USER}"

# Execute SQL in the Postgres container
function exec_psql() {
  docker exec -i "$CONTAINER_NAME" psql -U "$HOST_USER" -d tram -v ON_ERROR_STOP=1 "$@"
}

echo "Creating databases '$DB_NAME1' and '$DB_NAME2'..."
exec_psql <<SQL
CREATE DATABASE $DB_NAME1;
CREATE DATABASE $DB_NAME2;
SQL

echo "Creating user '$HOST_USER' and user-owned database '$HOST_USER'..."
exec_psql <<SQL
DO \$\$
BEGIN
  IF NOT EXISTS (
    SELECT FROM pg_catalog.pg_roles WHERE rolname = '$HOST_USER'
  ) THEN
    CREATE ROLE $HOST_USER LOGIN;
  END IF;
END
\$\$;

CREATE DATABASE $HOST_USER OWNER $HOST_USER;
SQL

echo "âœ… Done."
